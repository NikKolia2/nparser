const webpack = require('webpack')
const path = require('path')
const Promise = require('bluebird')
const MemoryFileSystem = require('memory-fs')
const os = require('os')
const {MD5} = require('crypto-js')
const nodeExternals = require('webpack-node-externals')

class TypescriptCompiler {
	constructor(entryPointPath) {
		this.vfs = new MemoryFileSystem()
		this.outputPath = path.resolve(os.tmpdir(), `${MD5(`compiled-file-${Date.now()}-${Math.random()}`).toString()}.js`)
		this.compiler = webpack({
			mode: 'development',
			devtool: 'inline-source-map',
			entry: entryPointPath,
			target: 'node',
			externals: [nodeExternals()],
			output: {
				path: path.dirname(this.outputPath),
				filename: path.basename(this.outputPath),
				libraryTarget: 'commonjs'
			},
			resolve: {
				extensions: ['.ts', '.js']
			},
			module: {
				rules: [{
					test: /\.ts$/,
					use: [
						{
							loader: 'ts-loader',
							options: {
								configFile: path.resolve(__dirname, './typescriptCompilerConfig.json')
							}
						}
					]
				}]
			}
		})
	}

	async run() {
		return new Promise((resolve, reject) => {
			this.compiler.outputFileSystem = this.vfs
			this.compiler.run((err, stats) => {
				if (err) {
					reject(err)
				} else {
					const content = this.vfs.readFileSync(this.outputPath).toString()
					resolve(content)
				}
			})
		})
	}
}

const typescriptCompiler = new TypescriptCompiler(process.argv[2])
typescriptCompiler.run().then(console.log).catch(console.error)
